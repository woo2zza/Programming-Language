{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-center " style="margin: 25px;" >
  <h1 class="fw-bold">{{ person.username }}의 프로필 페이지</h1><br>
</div>

<div style="display: flex; justify-content:space-between;"> 
  <div>
    <h4>
      <div style="display: flex; justify-content:space-between;"> 
        <p class="d-inline-flex gap-1">
          <a data-bs-toggle="collapse" href="#following" role="button" aria-expanded="false" aria-controls="following" class="btn btn-blue">
            팔로잉
          </a>
          <h4  id='followings-count'>{{ person.followings.all|length }}</h4>
        </div>
      </p>
      <div class="collapse" id="following">
        <div class="card card-body">
          <h3>Following List</h3>
          <hr>
          {% if followings|length %}
          {% for following in followings %}
              <h1>
              <ul>
                  <li>
                      <a href="{% url "accounts:profile" user %}">{{ following }}</a>
                  </li>
              </ul>
              </h1>
          {% endfor %}
          {% else %}
              <p>인원이 없습니다.</p>
          {% endif %}
      </div>
    </h4>
    <div>
      <h4>
        <div style="display: flex; justify-content:space-between;"> 
          <p class="d-inline-flex gap-1">
            <a data-bs-toggle="collapse" href="#follower" role="button" aria-expanded="false" aria-controls="follower" class="btn btn-blue">
              팔로워
            </a>
            <h4 id='followers-count'>{{ person.followers.all|length }}</h4>
          </div>
        </p>
        <div class="collapse" id="follower">
          <div class="card card-body">
            <h3>Follower List</h3>
              {% if followers|length %}
              {% for follower in followers %}
                  <h1>
                  <ul>
                      <li>
                          <a href="{% url "accounts:profile" user %}">{{ follower }}</a>
                      </li>
                  </ul>
                  </h1>
              {% endfor %}
              {% else %}
                  <p>인원이 없습니다.</p>
              {% endif %}
        </div>
      </h4>
  </div>




{% with followings=person.followings.all followers=person.followers.all %}
    <div>
      {% if request.user != person and request.user.is_authenticated %}
        <div>
          <form id='follow-form' data-user-id="{{person.pk}}">
            {% csrf_token %}
            {% if request.user in person.followers.all %}
              <input type="submit" value="Unfollow">
            {% else %}
              <input type="submit" value="Follow">
            {% endif %}
          </form>
        </div>
      {% endif %}
    </div>
  {% endwith %}


  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // 1. form 요소 선택
    const formTag = document.querySelector('#follow-form')
    // 6. csrf value 값 선택
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

    // 2. form 요소에 이벤트 리스너 부착
    formTag.addEventListener('submit', function (event) {
      // 3. submit 이벤트 기본 동작 취소
      event.preventDefault()
      
      // 5. form 요소에 지정한 data 속성 접근하기
      const userId = formTag.dataset.userId

      // 4. axios로 비동기적으로 팔로우 / 언팔로우를 요청
      axios({
        url: `/accounts/${userId}/follow/`,
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
      })
        .then((response) => {
          // console.log(response)
          // 7. Django에서 보낸 follow 여부를 알 수 있는 변수를 저장
          const isFollowed = response.data.is_followed
          // 8. 팔로우 버튼 조작
          const followBtn = document.querySelector('#follow-form > input[type=submit]:nth-child(2)')
          // 9. 팔로우 버튼 토글
          if (isFollowed === true)
          {
            followBtn.value = 'Unfollow'
          }
          else{
            followBtn.value = 'Follow'
          }

          // 10. 팔로워 / 팔로잉 수 처리
          const followingsCountTag = document.querySelector('#followings-count')
          const followersCountTag = document.querySelector('#followers-count')

          followingsCountTag.textContent = response.data.followings_count
          followersCountTag.textContent = response.data.followers_count
        })
        .catch((error) => {
          console.log(error)
        })
    })
  </script>


{% endblock %}
